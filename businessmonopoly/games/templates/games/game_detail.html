{% extends 'main/base.html' %}
{% load static %}
{% block content %}


<script>
    window.gameId = "{{ game.id }}";
    window.csrfToken = "{{ csrf_token }}";
    window.isObserver = {{ player.is_observer|yesno:"true,false" }};
    window.paused = {{ is_paused|yesno:"true,false" }};
</script>

<div style="max-width: 800px; margin: auto; padding: 20px; background-color: #f8f9fa; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative;">
    <h2 style="text-align: center;">{{ game.name }}</h2>

    <!-- –®–µ—Å—Ç–µ—Ä—ë–Ω–∫–∞ + –í—ã—Ö–æ–¥ + –£–ª—É—á—à–µ–Ω–∏–µ —Ä–æ–ª–∏-->
    <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 12px; align-items: center;">
        {% if user == game.creator %}
        <div style="position: relative; display: inline-block;">
            <button onclick="toggleSettingsMenu()" style="background: none; border: none; cursor: pointer; font-size: 22px;">‚öôÔ∏è</button>
            <div id="settings-menu" style="display: none; position: absolute; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; padding: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; min-width: 250px;">
                <button id="pause-button" onclick="togglePause()" style="margin-top: 10px; background-color: #0d6efd; color: white; padding: 6px 10px; border: none; border-radius: 4px; width: 100%;">
                    {% if game.is_paused %}‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É{% else %}‚è∏ –ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø–∞—É–∑—É{% endif %}
                </button>

                <form id="settings-form" style="margin-top: 10px;">
                    {% csrf_token %}
                    {{ settings_form.as_p }}
                    <button type="submit" style="margin-top: 10px; background-color: #198754; color: white; padding: 6px 10px; border: none; border-radius: 4px; width: 100%;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                </form>

                <button id="mode-toggle-button" onclick="toggleMode()" style="background-color: #6c757d; color: white; padding: 6px 10px; border: none; border-radius: 4px; width: 100%; margin-top: 10px;">
                    {% if player.is_observer %}–†–µ–∂–∏–º –∏–≥—Ä–æ–∫–∞{% else %}–†–µ–∂–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è{% endif %}
                </button>

                <button onclick="deleteGame()" style="background-color: #ff4d4f; color: white; padding: 6px 10px; border: none; border-radius: 4px; width: 100%; margin-top: 10px;">
                    –£–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É
                </button>
            </div>
        </div>
        {% endif %}

        <button onclick="leaveGame()" title="–í—ã–π—Ç–∏" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #dc3545; padding: 0;">üö™</button>
    </div>

    <script>
        function toggleSettingsMenu() {
            const menu = document.getElementById("settings-menu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        }
    </script>

    <!-- –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã -->
    <p style="text-align: center; font-size: 18px;">
        –í—Ä–µ–º—è –∏–≥—Ä—ã: <span id="game-timer" style="font-weight: bold;">00:00:00</span>
        <span id="pause-indicator">{% if is_paused %}<em>(–ø–∞—É–∑–∞)</em>{% endif %}</span>
    </p>

    <script type="module">
        import { initGameTimer } from "{% static 'js/timer.js' %}";
        window.timer = initGameTimer({{ elapsed_seconds|default:0 }}, "{{ is_paused|yesno:'true,false' }}");
    </script>

    <!-- –í–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã -->
    <div id="player-info" style="text-align: center; margin-top: 20px; {% if player.is_observer %}display:none;{% endif %}">
        <p><strong>–í–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã:</strong></p>
        <p>–î–µ–Ω—å–≥–∏: <span id="player-money">{{ player.money }}</span> üí∞</p>
        <p>–í–ª–∏—è–Ω–∏–µ: <span id="player-influence">{{ player.influence }} ‚≠ê</span></p>
        <p>–†–æ–ª—å: <span id="player-role">{{ player.get_role_display }}</span></p>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button data-pause onclick="toggleDisplay('transfer-form')"
                style="flex: 1; padding: 10px 0; font-size: 16px; background-color: #2f71f5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                üí± –ü–µ—Ä–µ–≤–µ—Å—Ç–∏
            </button>

            <button data-pause id="upgrade-role-button"
                style="{% if player.special_role != 0 or player.role > 2 %}display:none;{% endif %} flex: 1; padding: 10px 0; font-size: 16px; background-color: #2f71f5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                ‚¨ÜÔ∏è –£–ª—É—á—à–∏—Ç—å —Ä–æ–ª—å
            </button>
        </div>

        <form id="transfer-form" style="display:none; margin-top: 10px;">
            {% csrf_token %}
            <select id="receiver" name="receiver" required>
                {% for gp in players %}
                    {% if gp.user != request.user and not gp.is_observer %}
                        <option value="{{ gp.id }}">{{ gp.user.username }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <input type="number" id="amount" name="amount" min="1" placeholder="–°—É–º–º–∞" required style="width: 100px;">
            <button type="submit" style="padding: 4px 12px;">OK</button>
        </form>

        <div id="election-block" style="display:none; margin-top: 10px;">
        <button data-pause id="reelect-button"
                data-vote-url="{% url 'vote_for_official' game.id %}"
                style="flex: 1; width: 100%; padding: 10px 0; font-size: 16px; background-color: #2f71f5; color: white; border: none; border-radius: 6px; cursor: pointer;">
                üîÑ –ü–µ—Ä–µ–∏–∑–±—Ä–∞—Ç—å –ü–æ–ª–∏—Ç–∏–∫–∞
        </button>
        </div>

        <button data-pause id="ask-question-button"
                style="{% if player.special_role != 2 %}display:none;{% endif %} width:100%; margin-top:10px; padding:10px 0; font-size:16px; background-color:#6f42c1; color:#fff; border:none; border-radius:6px; cursor:pointer;">
          ‚ùì –í—ã–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
        </button>

        <div id="ask-question-modal"
             style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:3000;
                    align-items:center; justify-content:center;">
          <div style="background:#fff; padding:16px; border-radius:8px; width:360px;">
            <h3 style="margin:0 0 10px 0;">–ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</h3>

            <label for="ask-question-id" style="display:block; margin-bottom:6px;">‚Ññ –≤–æ–ø—Ä–æ—Å–∞ (–ø—É—Å—Ç–æ = —Å–ª—É—á–∞–π–Ω—ã–π)</label>
            <input id="ask-question-id" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 1"
                   style="width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:6px; margin-bottom:12px;">

            <h4 style="margin:0 0 6px 0; font-size:14px; font-weight:600;">–ö–æ–º—É –∑–∞–¥–∞—Ç—å?</h4>
            <select id="ask-target" style="width:100%; padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
              {% for gp in players %}
                {% if not gp.is_observer and gp.user_id != request.user.id %}
                  <option value="{{ gp.id }}">{{ gp.user.username }}</option>
                {% endif %}
              {% endfor %}
            </select>

            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:12px;">
              <button id="ask-cancel">–û—Ç–º–µ–Ω–∞</button>
              <button id="ask-send" style="background:#2f71f5; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </div>
        </div>


        <div id="election-modal"
             style="display:none; position:fixed; top:0; left:0; right:0; bottom:0;
                    background:rgba(0,0,0,.5); justify-content:center; align-items:center; z-index: 2000;">
          <div style="background:#fff; padding:20px; border-radius:8px; max-width:400px; width:100%;">
              <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞</h3>
              <div id="election-list"></div>
              <div id="election-empty" style="display:none; color:#888;">–ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤</div>
              <div style="margin-top:15px; display:flex; gap:10px; justify-content:flex-end;">
                  <button id="election-cancel">–û—Ç–º–µ–Ω–∞</button>
                  <button id="election-submit">–ì–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>
              </div>
          </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <h3 style="text-align: center; margin-top: 20px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
    <div id="players-list">
        {% for gp in players %}
            {% if not gp.is_observer %}
            <div class="player-card" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; background: #ffffff;">
                <div>
                    <strong>–ò–º—è:</strong> {{ gp.user.username }}<br>
                    <strong>–†–æ–ª—å:</strong> {{ gp.get_role_display }}<br>
                    <strong>–î–µ–Ω—å–≥–∏:</strong> {{ gp.money }} üí∞<br>
                    <strong>–í–ª–∏—è–Ω–∏–µ:</strong> {{ gp.influence }} ‚≠ê<br>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<script type="module">
    import { initWebSocket } from "{% static 'js/game-websocket.js' %}";
    initWebSocket("{{ game.id }}", "{{ request.user.username }}");

</script>

<script type="module">
    import {
        submitTransfer,
        togglePause,
        toggleMode,
        deleteGame,
        leaveGame,
        submitSettings,
        upgradeRole,
        initElectionUI,
        initPoliticianQuestions,
    } from "{% static 'js/game-actions.js' %}";

    document.addEventListener("DOMContentLoaded", () => {
        if (!window.isObserver) {
            submitTransfer(window.gameId, window.csrfToken);
            submitSettings(window.gameId, window.csrfToken);
            upgradeRole(window.gameId, window.csrfToken);
            initPoliticianQuestions(window.gameId, window.csrfToken);
        }

        initElectionUI("{{ request.user.username }}");
        window.togglePause = () => togglePause(window.gameId, window.csrfToken);
        window.toggleMode = () => toggleMode(window.gameId, window.csrfToken);
        window.deleteGame = () => deleteGame(window.gameId, window.csrfToken, "{% url 'create_game' %}");
        window.leaveGame = () => leaveGame(window.gameId, window.csrfToken, "{% url 'game_list' %}");
        applyPauseToButtons(!!window.paused);
    });
</script>

{% endblock %}