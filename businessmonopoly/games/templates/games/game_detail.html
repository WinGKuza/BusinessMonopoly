{% extends 'main/base.html' %}
{% load static %}
{% block content %}
<div style="max-width: 800px; margin: auto; padding: 20px; background-color: #f8f9fa; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative;">
    <h2 style="text-align: center;">{{ game.name }}</h2>

    <!-- –®–µ—Å—Ç–µ—Ä—ë–Ω–∫–∞ + –í—ã—Ö–æ–¥ -->
    <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 12px; align-items: center;">
        {% if user == game.creator %}
        <div style="position: relative; display: inline-block;">
            <button onclick="toggleSettingsMenu()" style="background: none; border: none; cursor: pointer; font-size: 22px;">‚öôÔ∏è</button>
            <div id="settings-menu" style="display: none; position: absolute; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; padding: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100;">
                <form method="post" action="{% url 'toggle_host' game.id %}" style="margin-bottom: 10px;">
                    {% csrf_token %}
                    <button type="submit" style="background-color: #6c757d; color: white; padding: 6px 10px; border: none; border-radius: 4px; width: 100%;">
                        {% if player.role == 0 %}–†–µ–∂–∏–º –∏–≥—Ä–æ–∫–∞{% else %}–†–µ–∂–∏–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è{% endif %}
                    </button>
                </form>
                <form method="post" action="{% url 'delete_game' game.id %}" onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É?')">
                    {% csrf_token %}
                    <button type="submit" style="background-color: #ff4d4f; color: white; padding: 6px 10px; border: none; border-radius: 4px; width: 100%;">
                        –£–¥–∞–ª–∏—Ç—å –∏–≥—Ä—É
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <form method="post" action="{% url 'leave_game' game.id %}" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" title="–í—ã–π—Ç–∏" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #dc3545; padding: 0;">üö™</button>
        </form>
    </div>

    <script>
        function toggleSettingsMenu() {
            const menu = document.getElementById("settings-menu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        }
    </script>

    <!-- –¢–∞–π–º–µ—Ä –∏–≥—Ä—ã -->
    <p style="text-align: center; font-size: 18px;">
        –í—Ä–µ–º—è –∏–≥—Ä—ã: <span id="game-timer" style="font-weight: bold;">00:00:00</span>
        {% if is_paused %}<em>(–ø–∞—É–∑–∞)</em>{% endif %}
    </p>

    <script>
        let elapsed = {{ elapsed_seconds|default:0 }};
        const paused = {{ is_paused|yesno:'true,false' }}, timerElement = document.getElementById('game-timer');
        function secondsToHMS(d) {
            d = Number(d);
            const h = Math.floor(d / 3600);
            const m = Math.floor((d % 3600) / 60);
            const s = Math.floor(d % 60);
            return [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
        }
        function updateTimer() {
            timerElement.innerText = secondsToHMS(elapsed);
            if (!paused) elapsed++;
        }
        setInterval(updateTimer, 1000);
        updateTimer();
    </script>

    <!-- –í–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã -->
    <div style="text-align: center; margin-top: 20px;">
        <p><strong>–í–∞—à–∏ —Ä–µ—Å—É—Ä—Å—ã:</strong></p>
        <p>–î–µ–Ω—å–≥–∏: {{ player.money }}</p>
        <p>–í–ª–∏—è–Ω–∏–µ: {{ player.influence }}</p>
        <p>–†–æ–ª—å: {{ player.get_role_display }}</p>
        <button onclick="document.getElementById('transfer-form').style.display='block'" style="margin-top: 15px; padding: 10px 60px; font-size: 16px; background-color: #2f71f5; color: white; border: none; border-radius: 6px; cursor: pointer;">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>

        <form id="transfer-form" action="{% url 'transfer_money' game.id %}" method="post" style="display:none; margin-top: 10px;">
            {% csrf_token %}
            <select name="receiver" required>
                {% for gp in players %}
                    {% if gp.user != request.user %}
                        <option value="{{ gp.id }}">{{ gp.user.username }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <input type="number" name="amount" min="1" placeholder="–°—É–º–º–∞" required style="width: 100px;">
            <button type="submit" style="padding: 4px 12px;">OK</button>
        </form>
    </div>

    {% if election_due %}
    <div style="text-align: center; margin-top: 10px;">
        <a href="{% url 'reelect_state' game.id %}">–ü–µ—Ä–µ–∏–∑–±—Ä–∞—Ç—å –≥–æ—Å –¥–µ—è—Ç–µ–ª—è</a>
    </div>
    {% endif %}

    <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <h3 style="text-align: center; margin-top: 20px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
    {% if players %}
    <div style="display: flex; flex-direction: column; gap: 12px;">
        {% for gp in players %}
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #dee2e6; border-radius: 8px; background: #ffffff;">
            <div>
                <strong>–ò–º—è:</strong> {{ gp.user.username }}<br>
                <strong>–†–æ–ª—å:</strong> {{ gp.get_role_display }}<br>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="text-align: center;">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤.</p>
    {% endif %}
</div>
{% endblock %}